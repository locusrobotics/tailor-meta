#!/usr/bin/make -f

%:
	dh $@ --parallel

export PYTHONUNBUFFERED=1
export PYTHONDONTWRITEBYTECODE=1
export PYTHONPYCACHEPREFIX="$HOME/.cache/cpython/"
export CCACHE_BASEDIR=$(CURDIR)

SHELL = bash
INSTALL_PREFIX = /opt/{{ organization }}/{{ release_label }}
INSTALL_DIR    = $(CURDIR)/debian/tmp$(INSTALL_PREFIX)

# Do this oneshot as part of override_dh_auto_install
override_dh_auto_clean:
override_dh_auto_configure:
override_dh_auto_build:
override_dh_auto_test:

override_dh_auto_install:
	mkdir -p "$(INSTALL_DIR)"
	ROS_DISTRO_OVERRIDE={{ organization }}-{{ release_label }} \
	colcon build \
		--packages-skip-build \
		--install-base "$(INSTALL_DIR)" \
		--build-base debian/tmp/build/{{ distro_name }} \
		--event-handlers console_direct+


# TODO(pbovbel) create separate debug packages
override_dh_strip:

# We don't really care about calculating shlibdeps
override_dh_shlibdeps:

override_dh_installdeb:
	# Fixup absolute and relative paths for installation target into /opt, don't touch .so libs
	find . -type f -exec grep -I -q . {} \; -print0 | xargs -0 sed -ri "s|($(CURDIR)/)?debian/tmp/opt|/opt|g" && \
	find . -name '*.pyc' -delete && \
	dh_installdeb

override_dh_builddeb:
	dh_builddeb \
		--filename=$(shell dpkg-parsechangelog -S Source)_$(shell dpkg-parsechangelog -S Version)_$(shell dpkg-architecture -qDEB_HOST_ARCH)_$(shell lsb_release -sc).deb \
		-- -Zzstd
